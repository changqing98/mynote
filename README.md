[TOC]
# 计算机技术（后端研发）知识点梳理

## 目录

[操作系统](#操作系统)

- [操作系统概论](#操作系统概论)
  - [进程与线程](#进程与线程)

[消息队列](#消息队列)

- [Kafka](#Kafka)

## 操作系统

操作系统是管理计算机硬件与软件资源的计算机程序。

### 操作系统概论

#### 进程与线程

##### 进程定义

进程是一段程序的执行过程。

##### 进程与线程的区别

进程是系统资源分配的最小单位，线程是处理机调度的最小单位。

## 消息队列

消息投递的三种语义

1. 至少一次
2. 至多一次
3. 精确一次

### Kafka

#### Kafka 基本概念

| 专业术语              | 解释                                                                               |
| --------------------- | ---------------------------------------------------------------------------------- |
| ISR(In Sync Replicas) | 同步副本列表，只有 ISR 中的副本才可以参选 leader                                   |
| LEO(Log End Offset)   | 分区的最后一条消息的 Offset                                                        |
| HW(High Water Mark）  | 高水位，Kafka 使用 Leader 副本的高水位作为分区的高水位，即对外消费者可见的消息偏移 |

#### Kafka 重要配置

##### 生产者配置

acks：可选值 0、1、all

- 0：leader 分区副本所在的 broker 收到请求，立即返回响应；
- 1：leader 分区副本所在的 broker 收到请求，且 leader 副本写入成功，才返回响应；
- all：leader 分区副本所在的 broker 收到请求，且所有副本写入成功，才返回响应。请求会被保存在一个缓冲区里，直到 leader 发现所有跟随者副本都复制了消息，响应才会被返回给客户端

#### 如何保证消息不丢失

为了实现这个目标，我们首先要清楚消息在什么情况下会丢失？

生产者端：

1. 生产者为异步发送（未配置回调接口），在请求 kafka broker 的过程中，请求失败、生产者服务或 kafka broker 宕机造成消息丢失
2. 生产者 acks 参数配置为 0，leader 副本所在的 broker 收到请求后立即返回响应，写入失败造成消息丢失；
3. 生产者 acks 参数配置为 1，leader 副本所在的 broker 收到请求并写入成功，但写入成功后 leader 副本所在的 broker 宕机了，其他副本尚未同步成功，此时 leader 切换造成消息丢失。

消费者端：

1. 先提交消息偏移 offset 再进行消息处理，如果此时消息处理发送异常，会造成消息丢失
2. 消费端采用线程池处理消息，其中某一个消息处理失败，但是后续的消息都处理成功，并且提交了 offset，导致消息丢失

根据以上问题，想要实现消息的不丢失首先需要保证两大前提，同时需要生产者、kafka broker、消费者端的协调来实现。

1. 消息提交成功
2. 消息所在的 broker 至少有一个存活

消息的不丢失实现方案：

1. 生产者设置 acks 参数为 all，且配置生产消息的回调函数，这样消息发送会有成功或失败结果回调，我们可以做相应的处理；
2. broker 端我们设置 min.insync.replicas 参数，副本数量不足时，拒绝处理新消息，即禁止生产者生产消息；将 unclean.leader.election.enable 参数设置为 false，即不允许不同步的副本参选 leader（会损失一些可用性）；
3. 消费者端我们这个可以设置偏移量的提交未手动提交，即每次消息处理成功，手动提交偏移。
   如果采用线程池消费消息，那就需要我们这边来保证消息处理是成功的，如果发生异常，我们需要进行业务报警，人工介入处理或者将消息持久化到数据库等，稍后进行重试。

#### Kafka 如何实现高可用

##### Broker 宕机

Kafka 的 Controller 在 zookeeper 的 broker 注册了监听，一旦一台 broker 宕机，controler 会读取改 broker 上所有的分区状态，并且所有
