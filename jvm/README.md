# JVM

## 一、概论

## 二、自动内存管理

### 2.1 运行时数据区

据Java虚拟机规范规定，Java虚拟机管理的内存将会包括以下几个区域

线程私有：

-   程序计数器

-   虚拟机栈

-   本地方法栈

    Hotspot的实现直接把本地方法栈与虚拟机栈合二为一。

线程共享：

-   堆

-   方法区

    方法区是Java虚拟机规范定义的内存区域，存储类型信息、常量、静态变量、即时编译器编译后的代码缓存等，有人将永久代与方法区混为一谈，其实是因为早期Hotspot采用永久代来实现方法区，但JDK6开始Hotspot团队开始放弃永久代，JDK7 Hotspot已经将永久代的字符串常量、静态变量移除，JDK8完全放弃了永久代，将JDK7中剩余的内容（主要是类型信息）全部移到元空间（metaspace，占用的是本地内存）中。

### 2.2 对象内存布局

1.  对象头

    1.  存放对象自身的运行时数据

        如对象的HashCode、

    2.  类型指针

    3.  数组长度（如果对象是一个数组）

2.  实例数据

3.  对其填充

    Java对象是按8字节对齐的

### 2.3 对象的访问定位

1.  句柄访问
2.  直接指针（Hotspot采用）

### 2.4 对象内存分配

#### 2.4.1 分配方式

1.  指针碰撞

    如果java堆的内存是规整的，即使用过的内存在一边，未使用的内存在另一边，中间有一个指针作为分界点的指示器，这样在创建对象的时候，只需要将指针往未使用过的方向移动对象大小的距离。

2.  空闲链表

#### 2.4.2 如果保证创建对象时指针修改的线程安全

1.  对分配内存空间的动作进行同步处理，具体实现上是采用CAS的方式来保证更新操作的原子性
2.  在java堆中预先分配一段线程私有的空间，成为本地线程分配缓冲TLAB
